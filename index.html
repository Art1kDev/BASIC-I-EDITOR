<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1.0,user-scalable=no">
<title>BASIC Suite</title>
<style>
body{margin:0;background:#000;color:#0f0;font-family:monospace;user-select:none;overflow:hidden}
.screen{display:flex;flex-direction:column;height:100vh}
.top{display:flex;gap:6px;padding:8px;border-bottom:2px solid #0f0;flex-wrap:wrap;user-select:none}
button,select{background:#000;color:#0f0;border:2px solid #0f0;font-family:monospace;font-size:16px;padding:8px 12px;cursor:pointer;border-radius:6px;outline:none;user-select:none}
select{appearance:none;-webkit-appearance:none;-moz-appearance:none}
.output{flex:1;padding:12px;overflow:auto;white-space:pre-wrap;font-size:18px;line-height:1.4em}
input{width:100%;background:#000;color:#0f0;border:none;outline:none;font-family:monospace;font-size:20px;padding:14px;border-top:2px solid #0f0;border-radius:0}
#canvas{display:block;background:#000;flex:1}
</style>
</head>
<body>
<div class="screen">
<div class="top">
<button tabindex="-1" onclick="RUN();blurInput()">RUN</button>
<button tabindex="-1" onclick="LIST();blurInput()">LIST</button>
<button tabindex="-1" onclick="NEW();blurInput()">NEW</button>
<select id="mode" tabindex="-1" onchange="CHANGE_MODE();blurInput()">
<option value="0">OLD BASIC</option>
<option value="1">APPLESOFT BASIC</option>
<option value="2">ICB-BASIC</option>
</select>
<button tabindex="-1" onclick="SAVE();blurInput()">SAVE</button>
<button tabindex="-1" onclick="OPEN();blurInput()">OPEN</button>
</div>
<div class="output" id="out"></div>
<canvas id="canvas" style="display:none"></canvas>
<input id="cmd" onkeydown="if(event.key=='Enter')CMD()">
<input type="file" id="file" accept=".txt" style="display:none" onchange="LOADFILE(this.files[0])">
</div>
<script>
let P={},V={},D=[],DP=0,FS=[],GS=[],R=false,LP=0,mode=0,seed=Math.random(),inputResolve=null,keyState={},canvas=document.getElementById("canvas"),ctx=canvas.getContext("2d"),out=document.getElementById("out")
canvas.width=window.innerWidth;canvas.height=window.innerHeight
window.addEventListener('resize',()=>{canvas.width=window.innerWidth;canvas.height=window.innerHeight})
window.addEventListener('keydown',e=>keyState[e.key.toLowerCase()]=true)
window.addEventListener('keyup',e=>keyState[e.key.toLowerCase()]=false)
if(localStorage.getItem("saved_program")){
let s=JSON.parse(localStorage.getItem("saved_program"))
P=s.P||{};mode=s.mode||0;document.getElementById("mode").value=mode
}
function SAVE_LOCAL(){localStorage.setItem("saved_program",JSON.stringify({P:P,mode:mode}))}
function O(t){if(mode==2){ctx.fillStyle="#0f0";ctx.font="18px monospace";ctx.fillText(t,10,30+(K().indexOf(LP)*20))}else{out.innerHTML+=t+"\n";out.scrollTop=1e9}}
function CLS(){if(mode==2)ctx.clearRect(0,0,canvas.width,canvas.height);else out.innerHTML=""}
function PIXEL(x,y,c){ctx.fillStyle=c||"#0f0";ctx.fillRect(x,y,1,1)}
function LINE(x1,y1,x2,y2,c){ctx.strokeStyle=c||"#0f0";ctx.beginPath();ctx.moveTo(x1,y1);ctx.lineTo(x2,y2);ctx.stroke()}
function waitForInput(promptText,varName,isString){O(promptText);cmd.disabled=false;cmd.focus();return new Promise(resolve=>{inputResolve=(val)=>{V[varName]=isString?val:parseFloat(val)||0;inputResolve=null;resolve()}})}
function K(){return Object.keys(P).map(Number).sort((a,b)=>a-b)}
function E(e){try{return eval(e)||0}catch{return 0}}
function EXEC(n){if(!R||!P[n]){R=false;return}LP=n;mode==2?ICBPROC(P[n]):mode?APROC(P[n]):BPROC(P[n])}
function NEXT(){let l=K(),i=l.indexOf(LP);i>=0&&i<l.length-1?EXEC(l[i+1]):(R=false)}
function J(t){P[t]?EXEC(t):(R=false)}
function RND(x){if(x<0)seed=-x;seed=(seed*16807)%2147483647;return seed/2147483647}
function PRINTLINE(s){let r="",p="",m=0;for(let i=0;i<s.length;i++){let c=s[i];if(c=='"')m^=1;if(!m&&(c==';'||c==',')){r+=E(p);if(c==',')r+="\t";p=""}else p+=c}r+=E(p);O(r)}
function BPROC(line){let s=line.trim(),w=s.split(" ")[0].toUpperCase(),a=s.slice(w.length).trim()
if(w=="PRINT"){PRINTLINE(a);NEXT()}
else if(w=="LET"){let m=a.match(/(.+?)=(.+)/);if(m)V[m[1].trim()]=E(m[2]);NEXT()}
else if(w=="IF"){let i=a.toUpperCase().indexOf("THEN");E(a.slice(0,i))?J(+a.slice(i+4)):NEXT()}
else if(w=="GOTO")J(+a)
else if(w=="END"||w=="STOP")R=false
else NEXT()}
function APROC(line){let s=line.trim(),w=s.split(" ")[0].toUpperCase(),a=s.slice(w.length).trim()
if(w=="PRINT"){PRINTLINE(a);NEXT()}
else if(w=="LET"){let m=a.match(/(.+?)=(.+)/);if(m)V[m[1].trim()]=E(m[2]);NEXT()}
else if(w=="INPUT"){let v=a.includes(";")?a.split(";")[1].trim():a,p=a.includes(";")?a.split(";")[0].replace(/"/g,""):"?";waitForInput(p,v,v.endsWith("$")).then(NEXT);return}
else if(w=="IF"){let i=a.toUpperCase().indexOf("THEN");let t=a.slice(i+4).trim();E(a.slice(0,i))?(/^\d+/.test(t)?J(+t):APROC(t)):NEXT()}
else if(w=="GOTO")J(+a)
else if(w=="END")R=false
else if(w=="CLS"){CLS();NEXT()}
else NEXT()}
function ICBPROC(line){let s=line.trim(),w=s.split(" ")[0].toUpperCase(),a=s.slice(w.length).trim()
if(w=="PRINT"){O(a);NEXT()}
else if(w=="CLS"){CLS();NEXT()}
else if(w=="PIXEL"){let m=a.split(",");PIXEL(E(m[0]),E(m[1]),m[2]);NEXT()}
else if(w=="LINE"){let m=a.split(",");LINE(E(m[0]),E(m[1]),E(m[2]),E(m[3]),m[4]);NEXT()}
else if(w=="INPUTKEY"){waitForInput("Press key",a,true).then(NEXT);return}
else if(w=="LET"){let m=a.match(/(.+?)=(.+)/);if(m)V[m[1].trim()]=E(m[2]);NEXT()}
else if(w=="IF"){let i=a.toUpperCase().indexOf("THEN");let t=a.slice(i+4).trim();E(a.slice(0,i))?(/^\d+/.test(t)?J(+t):ICBPROC(t)):NEXT()}
else if(w=="GOTO")J(+a)
else if(w=="END")R=false
else NEXT()}
function CMD(){let t=cmd.value.trim();cmd.value="";if(!t)return;if(inputResolve){inputResolve(t);return}if(/^\d+/.test(t)){let i=t.indexOf(" ");let n=+t.slice(0,i);let r=t.slice(i+1);r?P[n]=r:delete P[n];return}t=="RUN"?RUN():t=="LIST"?LIST():t=="NEW"?NEW():null}
function RUN(){R=true;if(mode==2){canvas.style.display="block";out.style.display="none"}else{canvas.style.display="none";out.style.display="block"};let l=K();if(!l.length)return;EXEC(l[0])}
function LIST(){K().forEach(n=>O(n+" "+P[n]))}
function NEW(){P={};CLS()}
function SAVE(){let s=K().map(n=>n+" "+P[n]).join("\n");let b=new Blob([s]);let a=document.createElement("a");a.href=URL.createObjectURL(b);a.download="program.txt";a.click()}
function OPEN(){file.click()}
function LOADFILE(f){let r=new FileReader();r.onload=()=>{P={};r.result.split("\n").forEach(l=>{let i=l.indexOf(" ");if(i>0)P[+l.slice(0,i)]=l.slice(i+1)});SAVE_LOCAL()};r.readAsText(f)}
function CHANGE_MODE(){mode=+document.getElementById("mode").value;SAVE_LOCAL()}
function blurInput(){setTimeout(()=>{document.getElementById("cmd").blur()},50)}
</script>
</body>
</html>
