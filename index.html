<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1.0,user-scalable=no">
<title>Multi BASIC</title>
<style>
@font-face{font-family:'1C';src:url('1C.ttf') format('truetype')}
body{margin:0;background:#000;color:#0f0;font-family:'1C',monospace}
.screen{display:flex;flex-direction:column;height:100vh}
.top{display:flex;gap:6px;padding:8px;border-bottom:2px solid #0f0;flex-wrap:wrap;user-select:none}
button,select{background:#000;color:#0f0;border:2px solid #0f0;font-family:'1C';font-size:16px;padding:8px 12px;cursor:pointer;border-radius:6px;outline:none;user-select:none}
select{appearance:none;-webkit-appearance:none;-moz-appearance:none}
.output{flex:1;padding:12px;overflow-y:auto;white-space:pre-wrap;word-break:break-word;font-size:18px;line-height:1.4em}
input{width:100%;box-sizing:border-box;background:#000;color:#0f0;border:none;outline:none;font-family:'1C';font-size:20px;padding:14px;border-top:2px solid #0f0;border-radius:0}
</style>
</head>
<body>
<div class="screen">
<div class="top">
<button onclick="RUN();blurInput()">RUN</button>
<button onclick="LIST();blurInput()">LIST</button>
<button onclick="NEW();blurInput()">NEW</button>
<button onclick="SAVE();blurInput()">SAVE</button>
<button onclick="OPEN();blurInput()">OPEN</button>
<select id="mode" onchange="CHANGE_MODE();blurInput()">
<option value="0">OLD BASIC</option>
<option value="1">APPLESOFT BASIC</option>
<option value="2">QBASIC</option>
<option value="3">TINY BASIC</option>
<option value="4">C64 BASIC</option>
</select>
<input type="file" id="file" accept=".txt" style="display:none" onchange="LOADFILE(this.files[0])">
</div>
<div class="output" id="out"></div>
<input id="cmd" onkeydown="if(event.key=='Enter')CMD()">
</div>
<script>
let P={},V={},D=[],DP=0,FS=[],GS=[],R=false,LP=0,mode=0,inputResolve=null
let out=document.getElementById("out"),cmd=document.getElementById("cmd")
function O(t){out.innerHTML+=t+"\n";out.scrollTop=out.scrollHeight}
function CHANGE_MODE(){mode=+document.getElementById("mode").value}
function K(){return Object.keys(P).map(Number).sort((a,b)=>a-b)}
function NEXT(){let l=K();let i=l.indexOf(LP);i>=0&&i<l.length-1?EXEC(l[i+1]):R=false}
function J(t){P[t]?EXEC(t):(R=false)}

function E(expr){
    if(!expr)return 0
    expr=expr.trim()
    for(let v in V){
        if(v.endsWith("$")){
            expr=expr.replace(new RegExp("\\b"+v+"\\b","g"),"`"+V[v]+"`")
        }else{
            expr=expr.replace(new RegExp("\\b"+v+"\\b","g"),V[v])
        }
    }
    expr=expr.replace(/`([^`]*)`/g,"'$1'")
    try{return eval(expr)}
    catch{return expr.includes("'")?expr:0}
}

function PRINTLINE(s){
    let r="",p="",m=0
    for(let i=0;i<s.length;i++){
        let c=s[i]
        if(c=='"')m^=1
        if(!m&&(c==';'||c==',')){r+=E(p);if(c==',')r+="\t";p=""}else p+=c
    }
    r+=E(p)
    out.innerHTML+=r
    if(!s.trim().endsWith(";"))out.innerHTML+="\n"
    out.scrollTop=out.scrollHeight
}

function RUN(){V={};DP=0;FS=[];GS=[];R=true;let l=K();if(!l.length)return;EXEC(l[0])}
function EXEC(n){if(!R||!P[n]){R=false;return}LP=n;switch(mode){case 0:BPROC(P[n]);break;case 1:APROC(P[n]);break;case 2:QBPROC(P[n]);break;case 3:TPROC(P[n]);break;case 4:C64PROC(P[n]);break;}}

function BPROC(line){let s=line.trim(),w=s.split(" ")[0].toUpperCase(),a=s.slice(w.length).trim();if(w=="PRINT"){PRINTLINE(a);NEXT()}else if(w=="LET"){let m=a.match(/(.+?)=(.+)/);if(m)V[m[1].trim()]=E(m[2]);NEXT()}else if(w=="IF"){let i=a.toUpperCase().indexOf("THEN");E(a.slice(0,i))?J(+a.slice(i+4)):NEXT()}else if(w=="GOTO")J(+a);else if(w=="END"||w=="STOP")R=false;else NEXT()}
function APROC(line){let s=line.trim(),w=s.split(" ")[0].toUpperCase(),a=s.slice(w.length).trim();if(w=="PRINT"){PRINTLINE(a);NEXT()}else if(w=="LET"){let m=a.match(/(.+?)=(.+)/);if(m)V[m[1].trim()]=E(m[2]);NEXT()}else if(w=="INPUT"){let v=a.includes(";")?a.split(";")[1].trim():a,p=a.includes(";")?a.split(";")[0].replace(/"/g,""):"?";waitForInput(p,v,v.endsWith("$")).then(NEXT);return}else if(w=="IF"){let i=a.toUpperCase().indexOf("THEN");let t=a.slice(i+4).trim();E(a.slice(0,i))?(/^\d+/.test(t)?J(+t):APROC(t)):NEXT()}else if(w=="FOR"){let m=a.match(/(\w+)\s*=\s*(.+)\s+TO\s+(.+?)(\s+STEP\s+(.+))?/i);let v=m[1],s_=E(m[2]),e=E(m[3]),st=m[5]?E(m[5]):1;V[v]=s_;FS.push({v:v,e:e,s:st,l:LP});NEXT()}else if(w=="NEXT"){let f=FS[FS.length-1];V[f.v]+=f.s;((f.s>0&&V[f.v]<=f.e)||(f.s<0&&V[f.v]>=f.e))?EXEC(f.l):(FS.pop(),NEXT())}else if(w=="DATA"){D=D.concat(a.split(","));NEXT()}else if(w=="READ"){a.split(",").forEach(v=>V[v.trim()]=D[DP++]);NEXT()}else if(w=="RESTORE"){DP=0;NEXT()}else if(w=="GOTO")J(+a);else if(w=="GOSUB"){GS.push(LP);J(+a)}else if(w=="RETURN"){LP=GS.pop();NEXT()}else if(w=="END")R=false;else NEXT()}
function QBPROC(line){let s=line.trim(),w=s.split(" ")[0].toUpperCase(),a=s.slice(w.length).trim();if(w=="PRINT"){PRINTLINE(a);NEXT()}else if(w=="LET"||w=="DIM"){let m=a.match(/(.+?)=(.+)/);if(m)V[m[1].trim()]=E(m[2]);NEXT()}else if(w=="INPUT"){let v=a.includes(";")?a.split(";")[1].trim():a,p=a.includes(";")?a.split(";")[0].replace(/"/g,""):"?";waitForInput(p,v,v.endsWith("$")).then(NEXT);return}else if(w=="IF"){let i=a.toUpperCase().indexOf("THEN");let t=a.slice(i+4).trim();E(a.slice(0,i))?(/^\d+/.test(t)?J(+t):QBPROC(t)):NEXT()}else if(w=="FOR"){let m=a.match(/(\w+)\s*=\s*(.+)\s+TO\s+(.+?)(\s+STEP\s+(.+))?/i);let v=m[1],s_=E(m[2]),e=E(m[3]),st=m[5]?E(m[5]):1;V[v]=s_;FS.push({v:v,e:e,s:st,l:LP});NEXT()}else if(w=="NEXT"){let f=FS[FS.length-1];V[f.v]+=f.s;((f.s>0&&V[f.v]<=f.e)||(f.s<0&&V[f.v]>=f.e))?EXEC(f.l):(FS.pop(),NEXT())}else if(w=="GOTO")J(+a);else if(w=="GOSUB"){GS.push(LP);J(+a)}else if(w=="RETURN"){LP=GS.pop();NEXT()}else if(w=="END")R=false;else NEXT()}
function TPROC(line){BPROC(line)}
function C64PROC(line){BPROC(line)}

function CMD(){let t=cmd.value.trim();cmd.value="";if(!t)return;if(inputResolve){inputResolve(t);return}if(/^\d+/.test(t)){let i=t.indexOf(" ");let n=+t.slice(0,i);let r=t.slice(i+1);r?P[n]=r:delete P[n];return}if(t.toUpperCase()=="RUN"){RUN()}else if(t.toUpperCase()=="LIST"){LIST()}else if(t.toUpperCase()=="NEW"){NEW()}}
function NEW(){P={};out.innerHTML=""}
function blurInput(){setTimeout(()=>{cmd.blur()},50)}

function LIST(){out.innerHTML="";K().forEach(n=>O(n+" "+P[n]))}
function SAVE(){let s=K().map(n=>n+" "+P[n]).join("\n");let b=new Blob([s],{type:"text/plain"});let a=document.createElement("a");a.href=URL.createObjectURL(b);a.download="program.txt";a.click()}
function OPEN(){document.getElementById("file").click()}
function LOADFILE(f){let r=new FileReader();r.onload=()=>{P={};r.result.split("\n").forEach(l=>{let i=l.indexOf(" ");if(i>0)P[+l.slice(0,i)]=l.slice(i+1)});LIST()};r.readAsText(f)}

function waitForInput(p,v,isString){O(p);cmd.disabled=false;cmd.focus();return new Promise(resolve=>{inputResolve=(val)=>{V[v]=isString?val:parseFloat(val)||0;inputResolve=null;resolve();cmd.disabled=false}})}
</script>
</body>
</html>
